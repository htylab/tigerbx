name: Compile Lite

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
# ============================================================
# 1. Build ── 針對三大 OS 編譯（排除 ants / optuna），上傳裸 binary
# ============================================================
  build:
    strategy:
      fail-fast: false
      matrix:
        os: [windows-latest, ubuntu-latest, macos-latest]
        py: ['tiger']
    runs-on: ${{ matrix.os }}

    steps:
    - name: Checkout source
      uses: actions/checkout@v4

    - name: Derive short commit SHA
      shell: bash
      run: echo "SHORT_SHA=${GITHUB_SHA::7}" >> "$GITHUB_ENV"

    - name: Disable macOS wheel compatibility check
      if: runner.os == 'macOS'
      run: echo "SYSTEM_VERSION_COMPAT=0" >> "$GITHUB_ENV"

    - name: Set up Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: "3.10"

    - name: Install build dependencies
      run: |
        python -m pip install --upgrade pip
        pip install ".[cpu]"
        pip install pyinstaller

    - name: PyInstaller (lite — exclude ants / optuna)
      shell: bash
      run: |
        pyinstaller -c -p . \
          --additional-hooks-dir=./pyinstaller_hooks \
          --icon=./tigerbx/exe/ico.ico \
          --exclude-module antspyx \
          --exclude-module ants \
          --exclude-module optuna \
          -F ./tigerbx_cli/${{ matrix.py }}.py

    - name: Prepare binary
      shell: bash
      run: |
        mkdir out
        if [[ "$RUNNER_OS" == "Windows" ]]; then
          cp dist/tiger.exe out/
        else
          cp dist/tiger out/
        fi

    - name: Upload binary artifact
      uses: actions/upload-artifact@v4
      with:
        name: tigerbx-lite-${{ runner.os }}-${{ env.SHORT_SHA }}
        path: out/

# ============================================================
# 2. Release ── 各 binary 各自壓成一顆 zip 後發布
# ============================================================
  release:
    needs: build
    runs-on: ubuntu-latest

    steps:
    - name: Derive short commit SHA
      run: echo "SHORT_SHA=${GITHUB_SHA::7}" >> "$GITHUB_ENV"

    - name: Download all build artifacts
      uses: actions/download-artifact@v4
      with:
        path: bins

    - name: List downloaded files
      run: find bins -type f | sort

    - name: Package each binary into its own zip
      run: |
        mkdir release
        for dir in bins/tigerbx-lite-*/; do
          name=$(basename "$dir")              # tigerbx-lite-Linux-abc1234
          platform=${name#tigerbx-lite-}      # Linux-abc1234
          platform=${platform%-*}             # Linux / macOS / Windows
          if [[ -f "$dir/tiger.exe" ]]; then
            zip -j "release/tigerbx-lite-${platform}-${SHORT_SHA}.zip" "$dir/tiger.exe"
          else
            zip -j "release/tigerbx-lite-${platform}-${SHORT_SHA}.zip" "$dir/tiger"
          fi
        done
        ls -lh release/

    - name: Create draft GitHub Release
      uses: ncipollo/release-action@v1
      with:
        tag: v${{ github.run_number }}-lite
        name: Release ${{ github.run_number }} (lite)
        body: |
          Lite build — excludes `antspyx` and `optuna`.

          **Supported:** `tiger bx`, `tiger hlc`, `tiger gdm`, `tiger nerve`
          **Supported (partial):** `tiger reg -A` (C2FViT affine), `tiger reg -r` (VMnet nonlinear)
          **Not supported:** `tiger reg -s/-S/-F` (SyN / SyNCC / FuseMorph — requires `antspyx`)

          For full registration support, use the Python package: `pip install "tigerbx[cpu]"`
        draft: true
        artifacts: release/tigerbx-lite-*.zip
        token: ${{ secrets.GITHUB_TOKEN }}
